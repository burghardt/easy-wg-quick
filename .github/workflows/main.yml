name: easy-wg-quick workflow

on:
  push:
  pull_request:
  schedule:
    - cron:  '0 0 * * *'

jobs:
  sast:
    name: sast
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: shellcheck
        uses: ./.github/actions/shellcheck
      - name: shfmt
        uses: ./.github/actions/shfmt
      - name: checkbashisms
        uses: ./.github/actions/checkbashisms
  tests:
    name: tests
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: unit tests
        uses: ./.github/actions/bats
  docker:
    name: docker
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: docker
        run: docker build . --tag ${{ github.event.repository.name }}:$(date +%s)
  macos:
    name: macos
    runs-on: macos-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: brew bundle
        run: brew bundle
      - name: unit tests
        run: ( cd tests ; ./runtests.bash )
      - name: create wghub.conf
        run: |
          echo none > fwtype.txt
          ./easy-wg-quick
          ./easy-wg-quick macos_named_client
      - name: dump configuration
        run: head *.txt *.key *.conf
      - name: dump wghub.conf
        run: cat wghub.conf
      - name: empty file check
        run: ls *.txt *.key *.conf | xargs -tn1 test -s
      - name: wg-quick up
        run: sudo wg-quick up ./wghub.conf
      - name: check interface
        run: sudo wg show
      - name: wg-quick down
        run: sudo wg-quick down ./wghub.conf
  ubuntu:
    name: ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: install wireguard
        run: sudo apt install -y wireguard-tools
      - name: create wghub.conf
        run: |
          echo none > fwtype.txt
          ./easy-wg-quick
          ./easy-wg-quick macos_named_client
      - name: dump configuration
        run: head *.txt *.key *.conf
      - name: dump wghub.conf
        run: cat wghub.conf
      - name: empty file check
        run: ls *.txt *.key *.conf | xargs -tn1 test -s
      - name: wg-quick up
        run: sudo wg-quick up ./wghub.conf
      - name: check interface
        run: sudo wg show
      - name: wg-quick down
        run: sudo wg-quick down ./wghub.conf
